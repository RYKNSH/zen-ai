---
description: リファクタリングの際の標準ワークフロー
---

# リファクタリングワークフロー

## Cross-Reference

```
/work "リファクタ" → /refactor → /verify --quick
/go → /work → /refactor → /verify
```

## 前提条件
- 対象コードにテストが存在すること（なければ先にテストを書く）
- リファクタリングの目的が明確であること

---

## リファクタリングの原則

> **重要**: リファクタリングと機能追加を同時に行わない

```
1. まずリファクタリングしてコードを整理
2. 次に新機能を追加
```

---

## ステップ

> 🧠 **THINK GATE — 計画フェーズ**: `WORKFLOW_CONTRACTS.md` の Core Engagement Matrix を参照。
> Small: H | Medium: H + T(quick) + N(quick) | Large: H + T + N(deep) + I

### 1. 目的の明確化
**目的**: なぜリファクタリングが必要かを明文化

```markdown
リファクタリングの理由：
- [ ] 可読性の向上
- [ ] 保守性の向上
- [ ] パフォーマンスの改善
- [ ] テスタビリティの向上
- [ ] 重複コードの削減
- [ ] 設計パターンの適用
- [ ] 技術的負債の返済

具体的な問題：
[現在のコードの何が問題か]

期待する結果：
[リファクタリング後、どうなるか]
```

---

### 2. 理想系の定義
**目的**: リファクタリング後のあるべき姿を定義

```markdown
現在の状態：
[現在のコードの構造、問題点]

理想の状態：
[リファクタリング後のあるべき姿]

理想との差分：
[埋めるべきギャップ]
```

---

### 3. テストの確認と追加
// turbo
**目的**: リグレッションを防ぐためのテストを確保

```bash
# 現在のカバレッジを確認
pnpm test:coverage

# 対象コードのテストを確認
pnpm test -- --grep "対象モジュール"
```

**重要**: カバレッジが80%未満の場合、先にテストを追加

---

### 4. 小さなステップで進める
**目的**: 変更を小さく保ち、各ステップでテストをパス

```markdown
リファクタリング計画：
1. [ ] ステップ1: [具体的な変更]
2. [ ] ステップ2: [具体的な変更]
3. [ ] ステップ3: [具体的な変更]

各ステップ後：
- テストを実行して全てパスすることを確認
- コミットして変更を保存
```

---

### 5. 各ステップの実行
// turbo
**目的**: 計画に沿ってリファクタリングを実行

各ステップで：

```bash
# 変更を加える

# テストを実行
pnpm test

# リンターを実行
pnpm lint

# 問題なければコミット
git add . && git commit -m "refactor: [変更内容]"
```

---

### 6. パフォーマンス検証（必要な場合）
// turbo
**目的**: リファクタリングによるパフォーマンス劣化がないことを確認

```bash
# ベンチマークの実行（プロジェクトに応じたコマンド）
pnpm benchmark
```

---

### 7. コードレビュー
**目的**: リファクタリングの妥当性を確認

**レビューポイント**:
1. 目的は達成されているか
2. 新たな問題を生んでいないか
3. コードは読みやすくなったか
4. テストは引き続き通るか

---

### 8. 品質ゲート通過
// turbo
**目的**: すべての品質基準をクリア

```bash
pnpm lint && pnpm typecheck && pnpm test && pnpm build
```

---

### 9. ドキュメント更新
**目的**: 変更に応じてドキュメントを更新

```markdown
更新が必要なドキュメント：
- [ ] README.md
- [ ] API ドキュメント
- [ ] アーキテクチャ図
- [ ] コードコメント
```

---

### 10. 振り返り
**目的**: リファクタリングの学びを記録

```markdown
振り返りポイント：
1. 当初の目的は達成できたか？
2. 予想より困難だった点は？
3. 次回に活かせる学びは？
4. 同様のコードが他にもあるか？
```

---

## アンチパターン

❌ **避けるべき行動**:

| アンチパターン | 代わりにすべきこと |
|--------------|------------------|
| 一度に大きな変更 | 小さなステップで進める |
| テストなしで変更 | 先にテストを書く |
| 機能追加と同時に行う | 別々のPRで行う |
| 動作確認せずにコミット | 各ステップでテスト |
| 完璧を目指す | 「より良い」を目指す |

---

### 11. 統合検証（自動）

> 🧠 **THINK GATE — 検証フェーズ**: `WORKFLOW_CONTRACTS.md` の Core Engagement Matrix を参照。
> Small: K(参照) | Medium: K + N(quick) | Large: K + N(deep) + T

リファクタリング完了後、`/verify --quick` を自動実行。
機能変更を伴わない変更でも、リグレッションがないことを確実に担保。
