---
description: 本番環境へのデプロイワークフロー
---

# デプロイワークフロー

## 前提条件
- すべての品質ゲートをクリアしていること
- main/master ブランチにマージ済みであること
- 環境変数が正しく設定されていること

## Cross-Reference

```
/verify → /ship Phase 4 → /deploy（内部実装）
/new-feature Step 9 → /deploy（参照）→ 実際は /ship 経由を推奨
```

> [!NOTE]
> `/deploy` はデプロイの実行手順。通常は `/ship` 経由で呼び出される。
> 直接 `/deploy` を使うのは緊急デプロイ時のみ。

---

## デプロイ前チェックリスト

### 必須項目
- [ ] すべてのテストがパス
- [ ] リンター/型チェックがパス
- [ ] 本番ビルドが成功
- [ ] コードレビュー完了
- [ ] CIパイプラインがグリーン

### 確認事項
- [ ] 環境変数の確認（新規追加があれば本番に設定）
- [ ] データベースマイグレーションの有無
- [ ] 破壊的変更の有無
- [ ] ロールバック手順の確認

---

## ステップ

### 1. 最終確認
// turbo
**目的**: デプロイ前の最終チェック

```bash
# 最新のmainブランチを取得
git checkout main
git pull origin main

# 品質チェック
pnpm lint
pnpm typecheck
pnpm test
pnpm build
```

---

### 2. 環境変数の確認
**目的**: 本番環境の設定が正しいことを確認

```markdown
確認項目：
- [ ] 新しい環境変数は本番に追加されているか
- [ ] 機密情報は適切に管理されているか
- [ ] 環境ごとの設定は正しいか
```

---

### 3. データベースマイグレーション（該当する場合）
**目的**: DBスキーマの変更を適用

```markdown
確認項目：
- [ ] マイグレーションスクリプトは正しいか
- [ ] ロールバックスクリプトは用意されているか
- [ ] ダウンタイムは許容範囲か
```

---

### 4. デプロイの実行
**目的**: 本番環境に変更を反映

#### Vercel（フロントエンド）
```bash
# Vercelは自動デプロイが設定されている場合、pushで自動実行
git push origin main

# 手動デプロイの場合
npx vercel --prod
```

#### Railway（バックエンド）
```bash
# Railwayは自動デプロイが設定されている場合、pushで自動実行
git push origin main

# 手動デプロイの場合
railway up --environment production
```

---

### 5. デプロイ後の検証
// turbo
**目的**: デプロイが成功したことを確認

```markdown
確認項目：
- [ ] アプリケーションが起動している
- [ ] 主要な機能が動作する
- [ ] エラーログに異常がない
- [ ] パフォーマンスが許容範囲内
```

```bash
# ヘルスチェック（URLは環境に応じて変更）
curl -I https://your-app.vercel.app/api/health
```

---

### 6. モニタリングの確認
**目的**: 異常がないことを継続的に確認

```markdown
監視項目：
- [ ] エラー率
- [ ] レスポンスタイム
- [ ] リソース使用率
- [ ] ユーザーからの報告
```

---

### 7. ロールバック手順（問題発生時）

#### 即時ロールバック
```bash
# 前のコミットに戻す
git revert HEAD
git push origin main

# または、前のデプロイバージョンに戻す
# Vercel: Dashboard > Deployments > 前のデプロイを選択 > Promote to Production
# Railway: Dashboard > Deployments > 前のデプロイを選択 > Rollback
```

#### データベースロールバック（該当する場合）
```bash
# マイグレーションのロールバック（プロジェクトに応じたコマンド）
pnpm db:rollback
```

---

## 緊急デプロイ手順

緊急修正が必要な場合の特別手順：

1. **Hotfixブランチを作成**
   ```bash
   git checkout main
   git checkout -b hotfix/issue-name
   ```

2. **修正を実装**
   - 最小限の変更のみ
   - テストを必ず追加

3. **緊急レビュー**
   - 最低1名のレビュアーの承認

4. **デプロイ**
   - 通常手順に従う

5. **振り返り**
   - 24時間以内にPost-mortemを実施

---

## Post-Deploymentチェックリスト

デプロイ後24時間以内に確認：

- [ ] すべての主要機能が正常に動作
- [ ] エラー率が通常レベル
- [ ] パフォーマンスが通常レベル
- [ ] ユーザーからの問題報告がない
- [ ] リソース使用率が許容範囲内
